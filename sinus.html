<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Sinus</title>
    <style>
        svg line{
            stroke: grey;
            stroke-width: 2;
        }
        svg circle{
            stroke: steelblue;
            fill: #21B2B4;
            stroke-width: 2;
        }
        .axis path, .axis line {
            fill: none;
            stroke: #333;
        }
        .axis .grid-line {
            stroke: #000;
            shape-rendering: crispedges;
            stroke-opacity: 0.2;
        }
        .axis text {
            font: 10px Verdana;
        }
    </style>
    <script src="http://d3js.org/d3.v3.min.js"></script>
</head>
<body id = 'body'>
<input id = "count" value = "1000"><br><br><input type = "range" id = "zoom" min = "1" max = "10" step = "1" value = "1" onchange="updateVal()"> Уровень зума: <t id = "zoomlevel"></t><br><br>
<input type = "button" id = "reload" value = "Перерисовать" onclick="repaint()">
<input type = "button" id = "remove" value = "Очистить" onclick="remove()"><br><br>
<input type = "checkbox" id = "alerting">Включить уведомления
<script type="text/javascript">
    var body = document.getElementById('body');
    var svgD = document.getElementById('svg');
    var countBox = document.getElementById('count');
    var seeposition = 0;
    var ctrl = false;
    var shift = false;
    var centerCoef = 200;

    repaint();
    updateVal();

    window.onresize = function() {
        repaint();
    };

    function updateVal(){
        document.getElementById('zoomlevel').innerText = document.getElementById('zoom').value;
        repaint();
    }

    function mousewheel(e){
        var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)))
        console.log('delta');
    }

    function remove(){
        d3.select('body').select('svg').remove();
    }

    function repaint(){
        var margin = 30;
        var width = window.innerWidth - 50;
        var height = window.innerHeight;
        var realHeight = 370;
        var lastY = 0;
        var x = 0;
        var scroolLevel = parseInt(document.getElementById('zoom').value);
        console.log("Scroll level: " + scroolLevel);
        var count = countBox.value;
        var startTime = new Date();
        var step = 0.1;
        var coef = (width - margin * 2) / count * scroolLevel;
        var array = new Array(count);
        var displaying = [{}];

        var svg = d3.select('body').select('svg');
        svg.remove();
        svg = d3.select('body').append('svg')
                .attr('id','svg')
                .attr('height', height)
                .attr('width', width)
                .attr('class', 'axis');

        svgD = document.getElementById('svg');
        for (var i = 0; i < count; i++){
            array[i] = Math.sin(i/10);
        }
        var seezone = {begin: seeposition * scroolLevel, end: array.length};

        /*for (var i = 0; i < array.length; i++){
            svg.append('line')
                    .attr('x1', x)
                    .attr('y1', lastY + 200)
                    .attr('x2', x+1)
                    .attr('y2', array[i] * 100 + 200);
            x += coef;
        }*/  //drawing line by line
        //x = coef * seezone.begin / scroolLevel;
        //console.log(seezone);
        if (centerCoef >= margin && centerCoef <= realHeight) displaying[displaying.length] = {x:margin, y:centerCoef};
        else if (centerCoef >= realHeight) displaying[displaying.length] = {x:margin, y:realHeight};
        else displaying[displaying.length] = {x:margin, y:margin};
        for (var i = seezone.begin; i < seezone.end; i += scroolLevel) {
            var value = (array[i] * 100) * scroolLevel + centerCoef;
            var point = 0;
            if (value <= realHeight && value >= margin) {
                point = {y: value, x: x * scroolLevel + margin};
            } else if(value <= margin){
                point = {y: margin, x: x * scroolLevel + margin};
            } else {
                point = {y: realHeight, x: x * scroolLevel + margin};
            }
            if (x < width - 2 * margin) {
                displaying[displaying.length] = point;
                if ((typeof point.x == "undefined" || typeof point.y == "undefined") || (point.x == null && point.y == null)) console.log('i: ' + i + 'array[i]:' + array[i] + 'scroll level: ' + scroolLevel)
                x += coef;
            }else console.log('Not in range of axis!');
        }
        /*for (var i = 1; i < displaying.length; i ++) {
            if (Math.abs(displaying[i-1].y - displaying[i].y) > 100) console.log("--- unusual value at x " + displaying[i].x + '\n1: ' + displaying[i-1].y + '\n2: ' + displaying[i].y);
        }*/
        if (centerCoef >= margin && centerCoef <= realHeight) displaying[displaying.length] = {x:x * scroolLevel + margin - coef, y:centerCoef};
        else if (centerCoef >= realHeight) displaying[displaying.length] = {x:x * scroolLevel + margin - coef, y:realHeight};
        else displaying[displaying.length] = {x:x * scroolLevel + margin - coef, y:margin};

        drawPoly(displaying, svg, scroolLevel);
        drawAxis(svg, width, 400, margin, count);

        var endTime = new Date();
        if (document.getElementById('alerting').checked == true) alert("Количество синусов: " + count + " штук\n" + startTime + "\n" + endTime + "\nЗатраченно времени: " + (-startTime.getMilliseconds() - startTime.getSeconds() * 1000 - startTime.getMinutes() * 60000
        + endTime.getMilliseconds() + endTime.getSeconds() * 1000 + endTime.getMinutes() * 60000) + " миллисекунд");
    }

    function drawAxis(svg, width, height, margin, maxX){
        // длина оси X= ширина контейнера svg - отступ слева и справа
        var xAxisLength = width - 2 * margin;

        // длина оси Y = высота контейнера svg - отступ сверху и снизу
        var yAxisLength = height- 2 * margin;

        // функция интерполяции значений на ось Х 
        var scaleX = d3.scale.linear()
                .domain([0, maxX])
                .range([0, xAxisLength]);
        var scaleY = d3.scale.linear()
                .domain([-1, 1])
                .range([0, yAxisLength]);

        // создаем ось X  
        var xAxis = d3.svg.axis()
                .scale(scaleX)
                .orient("bottom");
        var yAxis = d3.svg.axis()
                .scale(scaleY)
                .orient("left");

        // отрисовка оси              
        svg.append("g")
                .attr("class", "x-axis")
                .attr("transform",  // сдвиг оси вниз и вправо
                "translate(" + margin + "," + (height - margin) + ")")
                .call(xAxis);

        svg.append("g")
                .attr("class", "y-axis")
                .attr("transform", // сдвиг оси вниз и вправо на margin
                "translate(" + margin + "," + margin + ")")
                .call(yAxis);

        // создаем набор вертикальных линий для сетки  
        d3.selectAll("g.x-axis g.tick")
                .append("line") // добавляем линию
                .classed("grid-line", true) // добавляем класс
                .attr("x1", 0)
                .attr("y1", 0)
                .attr("x2", 0)
                .attr("y2", - (yAxisLength));

        // рисуем горизонтальные линии
        d3.selectAll("g.y-axis g.tick")
                .append("line")
                .classed("grid-line", true)
                .attr("x1", 0)
                .attr("y1", 0)
                .attr("x2", xAxisLength)
                .attr("y2", 0);
    }

    function drawPoly(points, svg){
        var pointsString = "";

        for (var i = 1; i < points.length; i++){
            if ((typeof points[i].x != "undefined" && typeof points[i].y != "undefined") && (points[i].x != null && points[i].y != null)) pointsString += points[i].x + "," + points[i].y + " ";
            else console.log('Invalid value!!! \ny: ' + points[i].y + '\nx: ' + points[i].x + '\ni: ' + i);
        }

        svg.append("polygon")
                .style("fill", "blue")
                .style("stroke", "steelblue")
                .style("stroke-width", "2")
                .attr("points", pointsString);
    }

    // Функция для добавления обработчика событий
    function addHandler(object, event, handler, useCapture) {
        if (object.addEventListener) {
            object.addEventListener(event, handler, useCapture ? useCapture : false);
        } else if (object.attachEvent) {
            object.attachEvent('on' + event, handler);
        } else alert("Add handler is not supported");
    }
    // Добавляем обработчики
    /* Gecko */
    addHandler(window, 'DOMMouseScroll', wheel);
    /* Opera */
    addHandler(window, 'mousewheel', wheel);
    /* IE */
    //addHandler(document, 'mousewheel', wheel);

    addHandler(window, 'keydown', ctrlF);
    addHandler(window, 'keyup', ctrlF);
    // Обработчик события
    function wheel(event) {
        var delta; // Направление скролла
        // -1 - скролл вниз
        // 1  - скролл вверх
        event = event || window.event;
        // Opera и IE работают со свойством wheelDelta
        if (event.wheelDelta) {
            delta = event.wheelDelta / 120;
            // В Опере значение wheelDelta такое же, но с противоположным знаком
            if (window.opera) delta = -delta;
            // В реализации Gecko получим свойство detail
        } else if (event.detail) {
            delta = -event.detail / 3;
        }
        // Запрещаем обработку события браузером по умолчанию
        if (event.preventDefault)  event.preventDefault();
        event.returnValue = false;
        if (!ctrl && !shift) {
            seeposition += delta * 5;
            if (seeposition < 0) seeposition = 0;
            console.log(seeposition);
        }
        else if (ctrl){
            var zoomrange = document.getElementById('zoom');
            if (delta > 0) delta = 1;
            else delta = -1;
            var value = parseInt(zoomrange.value) + delta;
            console.log('DELTA: ' + delta)
            if (value < 0) value = 0;
            zoomrange.value = value;
            document.getElementById('zoomlevel').innerText = document.getElementById('zoom').value;
        }
        else if (shift){
            centerCoef += delta * 5;
        }
        repaint();
        return delta;
    }

    function ctrlF(event){
        if (event.keyCode == "17") {
            if (event.type == "keydown") ctrl = true;
            else if (event.type == "keyup") ctrl = false;
        }
        if (event.keyCode == "16") {
            if (event.type == "keydown") shift= true;
            else if (event.type == "keyup") shift = false;
        }
    }
</script>
</body>
</html>